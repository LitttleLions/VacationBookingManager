{% extends "base.html" %}

{% block title %}{{ _('Calendar View') }}{% endblock %}

{% block content %}
<div class="calendar-container">
    <h2 class="calendar-title">{{ _('Weekly Calendar View') }}</h2>
    
    <form method="GET" action="{{ url_for('calendar_view') }}" class="filter-form">
        <input type="text" name="guest_filter" placeholder="{{ _('Filter by guest name') }}" value="{{ guest_filter }}">
        <select name="apartment_filter">
            <option value="">{{ _('All Apartments') }}</option>
            {% for apartment in apartments %}
            <option value="{{ apartment }}" {% if apartment_filter == apartment %}selected{% endif %}>{{ apartment }}</option>
            {% endfor %}
        </select>
        <input type="date" name="start_date_filter" value="{{ start_date_filter }}" placeholder="{{ _('Start Date') }}">
        <input type="date" name="end_date_filter" value="{{ end_date_filter }}" placeholder="{{ _('End Date') }}">
        <button type="submit">{{ _('Filter') }}</button>
    </form>

    <div class="calendar-navigation">
        <a href="{{ url_for('calendar_view', date=prev_week, guest_filter=guest_filter, apartment_filter=apartment_filter, start_date_filter=start_date_filter, end_date_filter=end_date_filter) }}" class="nav-button">&lt; {{ _('Previous Week') }}</a>
        <input type="date" id="datePicker" value="{{ current_date.strftime('%Y-%m-%d') }}" class="date-picker">
        <a href="{{ url_for('calendar_view', date=next_week, guest_filter=guest_filter, apartment_filter=apartment_filter, start_date_filter=start_date_filter, end_date_filter=end_date_filter) }}" class="nav-button">{{ _('Next Week') }} &gt;</a>
    </div>

    <div class="calendar-week">
        <div class="week-number">{{ _('Week') }} {{ week_number }}</div>
        <table class="calendar-table">
            <thead>
                <tr>
                    <th class="apartment-header">{{ _('Apartment') }}</th>
                    {% for date in week_dates %}
                    <th class="date-header {% if date.date() == today %}current-day{% endif %}">
                        <div class="date-day">{{ date.strftime('%a') }}</div>
                        <div class="date-number">{{ date.strftime('%d/%m') }}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for apartment in apartments %}
                {% if calendar_data.get(apartment) and calendar_data[apartment]|length > 0 %}
                <tr>
                    <td class="apartment-name">{{ apartment }}</td>
                    {% for date in week_dates %}
                    <td class="calendar-cell {% if date.date() == today %}current-day{% endif %}">
                        {% for booking in calendar_data[apartment].get(date, []) %}
                        <div class="booking-item" data-booking='{{ booking|tojson|forceescape }}'>
                            <div class="booking-guest">{{ booking.guest_name }}</div>
                            <div class="booking-details">
                                <div>{{ _('Check-in') }}: {{ booking.check_in }}</div>
                                <div>{{ _('Check-out') }}: {{ booking.check_out }}</div>
                                <div>{{ _('Guests') }}: {{ booking.guests }}</div>
                                <div>{{ _('Channel') }}: {{ booking.channel_name }}</div>
                                {% if booking.assistantNotice %}
                                <div>{{ _('Assistant Notice') }}: {{ booking.assistantNotice }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('datePicker').addEventListener('change', function(e) {
    const url = new URL(window.location.href);
    url.searchParams.set('date', e.target.value);
    window.location.href = url.toString();
});
</script>
{% endblock %}
